#!/bin/bash

mkdir -p config || exit
cd config || exit

echo "$BATCH_SIZE" > batch.config

rm -f clients.config

if [[ -v CLUSTER ]]; then
  if [[ $CLUSTER == "1" ]]; then
    #Flag to set on the machines in the cop cluster
    REPLICA_MACHINES=("192.168.85.24" "192.168.85.25" "192.168.85.26" "192.168.85.27")
  else
    REPLICA_MACHINES=("10.11.12.1" "10.11.12.2" "10.11.12.3" "10.11.12.4")
  fi
else
  REPLICA_MACHINES=("10.11.12.1" "10.11.12.2" "10.11.12.3" "10.11.12.4")
fi

if [[ ! -v MAX_CLIENTS ]]; then
  MAX_CLIENTS=$NUM_CLIENTS
fi

#10gbe
CLIENT_MACHINES="10.11.12.5 192.168.70.16"

#1gbe
#CLIENT_MACHINES="192.168.85.30"

CURR_MACHINE=0
for ip in $CLIENT_MACHINES; do
  for i in $(seq 0 $(expr "$NUM_CLIENTS" - 1)); do
      id=$(expr 1000 + $(expr $(expr $CURR_MACHINE \* "$MAX_CLIENTS") + "$i"))
      sni=cli${id}
      port=$(expr 11000 + "$i")
      echo "$id" "$sni" "$ip" "$port" >> clients.config
  done

  CURR_MACHINE=$(expr $CURR_MACHINE + 1)
done

rm -f replicas.config

CURR_IP=0
for id in $(seq 0 $(expr "$NUM_REPLICAS" - 1)); do
    sni=srv${id}
    port=$(expr 10000 + "$id")
    rep_port=$(expr 12000 + "$id")
    host=$(expr "$id" % 4)

    #1gbe
    #host=$(expr 24 + $host)
    #echo $id $sni 192.168.85.$host $port $rep_port >> replicas.config

    #10gbe
    echo "$id" "$sni" "${REPLICA_MACHINES[$CURR_IP]}" "$port" "$rep_port" >> replicas.config

    CURR_IP=$(expr $CURR_IP + 1)
done
